<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Créer un compte – Thoth</title>
  <link rel="stylesheet" href="thoth.css">
  <script src="https://cdn.jsdelivr.net/npm/backendless"></script>
  <style>
    /* Message succès */
    #successMessage {
      color: red;
      font-style: italic;
      text-transform: lowercase;
      margin-top: 15px;
      display: none;
    }
  </style>
</head>
<body>

  <div class="overlay">
    <!-- Bouton retour -->
<a href="login.html" class="btn-back" onclick="vibrateButton()">
  &#8592; Retour
</a>
    <h1>Créer un compte</h1>
    <p>Rejoignez-nous pour explorer la ligne temporelle</p>

    <form id="signupForm">
      <input type="email" name="email" placeholder="exemple@domaine.com" required>
      <input type="text" name="nom" placeholder="Jean Dupont" required>
      <input type="text" name="institut" placeholder="Université de Kinshasa" required>
      <input type="text" name="option" placeholder="Informatique / Médecine" required>
      
      <button type="submit" class="btn-connexion" onclick="vibrateButton()">S'inscrire</button>
    </form>

    <!-- Message succès -->
    <p id="successMessage">Un email de confirmation a été envoyé à votre adresse. Veuillez vérifier votre boîte de réception pour obtenir le matricule."
    </p>

    <!-- Message d'erreur -->
    <p id="errorMessage" style="color:red; display:none; margin-top:15px;"></p>
  </div>
  

  <script>
    // Backendless config
    const APP_ID = "B4A3DE5F-5247-43FC-8831-C87303139B55";
    const API_KEY = "0D40C30E-CC67-4C67-B532-1BF5BB94BCC4";
    const TABLE  = "membres";

    Backendless.initApp(APP_ID, API_KEY);

    // Vibration
    function vibrateButton() {
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    const form = document.getElementById('signupForm');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const email = form.email.value.trim();
      const nom = form.nom.value.trim();
      const institut = form.institut.value.trim();
      const option = form.option.value.trim();

      try {
        // Vérifier si l'utilisateur existe déjà
        const query = Backendless.Data.QueryBuilder.create().setWhereClause(`email = '${email}'`);
        const existing = await Backendless.Data.of(TABLE).find(query);

        if (existing.length > 0) {
          errorMessage.style.display = "block";
          errorMessage.textContent = "Ce compte existe déjà !";
          return;
        }

        // Créer le membre
        const membre = { email, nom, institut, option };
        await Backendless.Data.of(TABLE).save(membre);

        // Afficher le message succès
        successMessage.style.display = "block";
        errorMessage.style.display = "none";

        // Vider le formulaire
        form.reset();

        // Redirection automatique après 8 secondes
        setTimeout(() => {
          window.location.replace("login.html"); // replace pour ne pas pouvoir revenir
        }, 8000);

      } catch (error) {
        console.error(error);
        errorMessage.style.display = "block";
        errorMessage.textContent = "Une erreur est survenue, réessayez.";
      }
    });

    // Empêcher retour arrière
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
      history.go(1);
    };
  </script>

</body>
</html>
